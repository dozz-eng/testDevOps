# testDevOps
Евгений Овсянкин 

Тестовое задание для DevOps-инженера.

1. **Общие концепции DevOps:**

Направление DevOps родилось, как методология разработки ПО для улучшения взаимодействия разных групп разработчиков. Впоследствии оно вылилось в название специальности: DevOps-инженер.
DevOps-инженер в общих чертах служит связующим звеном между командами, отвечающими за разные компоненты приложения. В случаях когда непонятно откуда приходит баг помогает разобраться куда смотреть, кого привлечь к работе и т.д.

DevOps-инженер в команде решает следующие задачи:
- подготовка инфраструктуры для проекта(сервера, виртуальные машины, сетевые устройства) их настройка
- настройка процесса CI/CD от пуша в репозиторий изменений кода до сборки проекта, тестирования, выкладки готового проекта на хостинг. 
- производит настройку системы мониторинга и логгирования работы проекта на всех стадиях
- участвует в разборе нештатных ситуаций работы приложения на основе данных логирования и мониторинга. Чем оптимальнее настроены данные компоненты, тем меньше времени уходит на разбор.
- настраивает работу оркестраторов (Ansible, Kubernetes) для обеспечения бесперебойной работы приложения. При возрастаниях нагрузки на приложение система должна автоматически масштабироваться (увеличивается количество контейнеров и т.д.)

2. **CI/CD (Continuous Integration and Continuous Deployment):**

- CI/CD или непрерывная интеграция и непрерывная доставка приложения - это "конвейер", обеспечивающий немедленную пересборку, тестирование и доставку обновленного приложения на хостинг без ручного вмешательства в процесс. В идеале он должен запускаться после пуша изменений в репозиторий, произвести все настроенные действия по сборке, выкладке приложения на тестовый стенд и тестированию. Если все тесты прошли без ошибок, возможно нужно подтверждение инженера перед деплоем приложения в prod. 

- В CI/CD можно выделить 3 основных этапа:
    - Сборка
    - Тестирование
    - Деплой

В более сложных системах есть этапы настройки инфраструктуры для теста, развертывание компонентов приложения, выполнение дополнительных действий (перезапуск сервисов, вызов дополнительных сервисов), Логирование и оптравка оповещений о состоянии поставки и т.д.

3. **Мониторинг и логирование:**
    
Мониторинг является одной из самых важных работ в сопровождении приложения. До того, как приложение "упадет", могут быть различные к этому предпослки (мало еста на жестком диске, например). Система может дать оповещение обслуживающему персоналу, чтобы тот мог предпринять необходимые меры. 
Инструментами для мониторинга являются Zabbix или Prometeus. Они могут присылать различные оповещения: Email, SMS, Telegram - все зависит от предпочтений инженера, настраивающего данный сервис.
Для удобного просмотра метрик приложения можно настроить дашборды, встроенные в данные системы, или подключить инструменты для отображения, такие, как Grafana.

Отличия мониторинга и логгирования: 

- Мониторинг производится в реальном времени, и оповещения присылаьтся сразу по наступлении важного события. 

- Логгирование представляет из себя сбор сообщений о действиях, происходящих в системе, и их может быть очень много. Логи также могут отсылаться со всех машин на центральный syslog-сервер. Логи в основном используют для расследования инцидентов, чтобы понять что привело к ошибке. Просмотр логов в текстовом виде является крайне непродуктивным занятием, поэтому придумано довольно много систем для удобного парсинга, фильтрации и сохранения их. Отличным примером такого решеия является сервер ELK (связка Elacticsearch, Logstash и Kibana)
Логи могут использоваться и в реальном времени, например, система может отслеживать логи, связанные со входом пользователя в систему и информировать администратора о попытках несанкционированного проникновения.

4. **Контейнеризация и Docker:**

Виртуальные машины запускаются посредством гипервизора, который является прослойкой между физическим сервером и виртуальными машинами. Гипервизор - это программа, запускаемая на хостовой системе, предоставляющая виртуальное железо гостевым системам. Виртуальные машины представляют собой полновесные операционные системы, содержащие ядро, пространство пользователя, приложения и т.д.

Докер представляет собой "аналог" виртуальной машины, но в составе образа докера отсутствует ядро системы. Запускается докер посредством программы Docker Engine, которая предоставляет ресурсы хостовой системы запущенным контейнерам. Из собственных компонентов контейнер имеет только систему файлов и приложения, запущенные внутри докера. Этим объясняется малый "вес" докер-образа. 
Ввиду отсутствия собственного ядра системы и гипервизора ресурсы хостовой машины используются более рационально, увеличивая быстродействие системы в общем. 

Основные команды в docker:

    docker pull <image_name> - скачивание образа с сайта dockerhub
    docker run|stop <image_name> - запуск|останов образа
    docker ps - вывод списка запущенных контейнеров
    docker images - вывод списка докер-образов в системе
    docker rm <image_name> - удаление выбранного образа 

    docker build . - сборка образа из Dockerfile

5. **Сетевые основы:**

**NAT или Network Addess Translation** - технология, изначально призванная компенсировать недостаток IP-адресов в мире. 

Изначально протокол IP предусматривал около 4 млрд адресов в виде xxx.xxx.xxx.xxx, но с ростом количества устройств в мире стало невозможно выдать каждому устройству индивидуальный адрес. 
для решения проблемы диапазоны адресов разделили на "публичные" (белые) и "приватные" (серые).
Диапазоны серых адресов:

    - 192.168.0.0/26
    - 10.0.0.0/8
    - 172.16.0.0/8

В малых сетях локального значения используются данные диапазоны, а во всемирной сети - все остальные.

NAT вступает в дело, когда нужно предоставить доступ в интернет устройствам из локальной сети. 
В качестве NAT-роутера (шлюза) выступает сетевое устройство - маршрутизатор. Шлюз имеет на борту минимум 2 интерфейса, один подкючен к локальной сети, другой - к глобальой.
Порядок работы NAT:

- Хост в локальной сети, отправляющий пакет другому хосту из всемирной паутины отправляет его на шлюз.
- Шлюз записывает в таблицу IP-адрес отправителя, и заменяет в пакете на свой внешний адрес.
- Пакет отправляется с внешнего интерфейса получателю.
- Получатель обрабатывает пакет, формирует ответ и отправляет его обратно на внешний адрес шлюза.
- Шлюз согласно своей таблице пересылает пакет хосту в локальной сети.

Данная технология в сообществе Linux  называется "source nat" (исходящий NAT). Это лишь один из вариантов использования технологии. Есть, к примеру, "destination nat" (входящий NAT или проброс портов), позволяющий подключиться к хосту, находящемуся в "серой" сети извне.

**DNS или Domain Name Server** - технология разрешения имени ресурса в IP-адрес.

На заре развития интернета, когда количество компьютеров можно было пересчитать по пальцам, обращение к ресурсу в интернете производилось напрямую по IP-адресу. Соответствие имени IP-адресу настраивалось в каждом компьютере в файлике hosts.

С ростом количества устройств, поддерживать актуальное состояние файлов hosts стало невозможно. На смену файлам появились DNS-сервера, которые взяли на себя эту функцию. На каждом компьютере осталось только настроить IP-адрес DNS-сервера. При вводе в браузере имени ресурса, комьютер сначала проверяет, есть ли у нео в кэше информация и, если нет, он отправляет запрос на DNS-сервер. 

DNS-сервера иерархически структурированы, подчинены друг другу. Если нижестоящий DNS-сервер не знает ответа, он перенаправляет запрос вышестоящему DNS-серверу. И так до тех пор, пока не найдется запись, или подтверждение, что такая запись не существует. 

В локальной сети можно настроить свой DNS-сервер. Он может находиться между локальной и глобальной сетью и кэшировать информацию о запрашиваеых ресурсах, что уменьшает время ожидания ответа. Также, на нем может находиться информация о хостах в локальной сети, чтобы хосты в ней могли обращаться друг к другу по доменному имени. 

6. **Git и управление версиями:**

Ветвление в Git предоставляет разработчикам удобную возможность добавлять новый функционал в проект, не изменяя при этом  код в основной ветке.

Разработчик делает новую ветку из master, называет ее, например, feature01 и начинает изменять код. Изменения не отражаются в основной ветке. Добаавив функционал, проверив его, запушив соммит на сервер, разработчик может инициировать слияние своей ветки с основной. Эта перация называется pull-request. После выполнения pull-request'а код в основной ветке сливается с кодом в ветке feature01. Функционал добавлен.

Для создания новой ветки и переключения на нее существует команда:

    git checkout -b <new_branch_name>

7. **Безопасность:**

**Методы обеспечения безопасности:**

- Полная изоляция сети от интернета, выдача доступа только по необходимости. (не на всех системах, например у меня на работе так. Внутренняя сеть со SCADA-системой не имеют доступа в интернет)
- Надежный пароль
- Отключение доступа на сервер по паролю, настройка доступа по ssh-ключам
- на серверах c Linux можно использовать дополнительное по для защиты от перебора паролей (file2ban)
- Настройка firewall, для фильтрации сетевого трафика.
- технология NAT, настроенная на маршрутизаторе, обеспечивает защиту от сканирования сети. 
- VPN
- SSL/TLS шифрование соединений. 

**SSH**

Сетевой протокол для безопасного доступа к удалённым компьютерам и серверам. Он обеспечивает шифрование данных и защищает их от перехвата и подделки.

Для подключения к серверу по SSH, на нем должен быть запущен SSH-сервер. По умолчанию сервер прослушивает 22 порт. 
На клиенте необходимо запустить SSH-клиент. Для подключения к серверу из терминала нужно ввести строку вида:

    ssh <name>@<IP или hostname> -p <port>

Далее система попросит ввести пароль, и если аутентификация прошла успешно клиент находиться виртуальной консоли сервера. 

Для более безопасной работы рекомендуется настроить подключение по ключам. Для этого необходимо сгенерировать на удаленном компьютере пару ключей (публичный и приватный). Публичный ключ кладется на сервер в папку /home/<user>/.ssh
Приватный должен находиться в надежном месте и никому нельзя его передавать.
После этих действий при подключении к серверу система не будет требовать пароль.

8. **Оркестрация:**

Оркестрация - это система управления контейтерами. Следуя методологии IaC (Infrastructure as Code) приводит состояние системы к описанному в манифесте.
Манифест - текстовый файл, написанный на языке yaml. 
Согласно манифесту, система организует заданное количество контейнеров, производит сборку, деплой, запуск, перезапуск, 
масштабирование системы в зависимости от нагрузки. Система может отслеживать состояние контейнера, и в случае некорректного поведения перезапускать его. 

Самый распространенный оркестратор контейнеров - Kubernetes.

9. **Docker-compose**

    - Как можно изменить файл, чтобы добавить том для хранения данных PostgreSQL?

Данный файл запускает два контейнера web и db. 
web - контейнер с сервером nginx и пробросом порта 8080 из компьютера на порт 80 контейнера. 
db - контейнер базой данных PostgreSQL и настроенными переменными окружения для подключения к базе (пользователь и пароль)

Для запуска данного файла на сервере должны быть установлены Docker Engine и Docker Compose.
Команда для запуска 

    docker-compose up -d

    где -d - значит запустить в фоновом режиме

При этом нужно находиться в той же папке, где находится файл. Если находимся в другом месте, к данной команде необходимо дописать флаг -f <путь до файла

